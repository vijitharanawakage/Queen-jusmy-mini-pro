const axios = require("axios");
const config = require("../config");

// Heroku App URL
const PAIR_SITE = 'https://sila-md-mini-bot.onrender.com';

module.exports = {
  command: "pair",
  desc: "Get pairing code for mini inconnu xd AI bot",
  use: ".pair 653078046968",
  filename: __filename,

  execute: async (socket, msg, args) => {
    const messages = {
      invalid: "*DO YOU WANT SILA MD MINI BOT PAIR CODE ðŸ¤”*\n*THEN WRITE LIKE THIS â˜ºï¸\n\n*PAIR +255612491554*\n\n*WHEN YOU WRITE LIKE THIS ðŸ˜‡ THEN YOU WILL GET SILA MD MINI BOT PAIR CODE ðŸ˜ƒ YOU CAN LOGIN IN YOUR WHATSAPP ðŸ˜ YOUR MINI BOT WILL ACTIVATE ðŸ¥°*",
      failed: "*PLEASE TRY AGAIN AFTER SOME TIME ðŸ¥ºâ¤ï¸*",
      done: "*ðŸ¢ SILA MD MINI BOT ðŸ¢*\n*PAIR CODE COMPLETED ðŸ˜‡â¤ï¸*",
      error: "*PAIR CODE IS NOT CONNECTING TO YOUR NUMBER â˜¹ï¸*",
    };

    try {
      // Get sender details
      const senderId = msg.sender || msg.key?.participant || msg.key?.remoteJid || "";
      const senderNumber = senderId.split("@")[0];

      // Use args or fallback
      const phoneNumber = args.length > 0 ? args.join(" ").trim() : "";

      if (!phoneNumber) {
        return socket.sendMessage(
          msg.key?.remoteJid || senderId,
          {
            text: `*ðš‚ð™¸ð™»ð™° ð™¼ð™³ ð™¼ð™¸ð™½ð™¸ ð™±ð™¾ðšƒ ð™µð™¾ðš ðšˆð™¾ðš„ðš ð™½ðš„ð™¼ð™±ð™´ðš â˜ºï¸*\n*ðš†ðšð™¸ðšƒð™´ ð™»ð™¸ð™ºð™´ ðšƒð™·ð™¸ðš‚ ðŸ˜‡*\n\n *.ð™¿ð™°ð™¸ðš â®+255612491554â¯*\n\n *ð™¸ð™½ðš‚ðšƒð™´ð™°ð™³ ð™¾ð™µ ðšƒð™·ð™¸ðš‚ ð™½ðš„ð™¼ð™±ð™´ðš ðš†ðšð™¸ðšƒð™´ ðšˆð™¾ðš„ðš ð™½ðš„ð™¼ð™±ð™´ðš ð™¾ð™º ðŸ˜Š ðšƒð™·ð™´ð™½ ðšˆð™¾ðš„ ðš†ð™¸ð™»ð™» ð™¶ð™´ðšƒ ð™¿ð™°ð™¸ðšð™¸ð™½ð™¶ ð™²ð™¾ð™³ð™´ ðŸ˜ƒ ðšˆð™¾ðš„ ð™²ð™°ð™½ ð™»ð™¾ð™¶ð™¸ð™½ ðš†ð™¸ðšƒð™· ðšƒð™·ð™°ðšƒ ð™¿ð™°ð™¸ðšð™¸ð™½ð™¶ ð™²ð™¾ð™³ð™´ ð™¸ð™½ ðšˆð™¾ðš„ðš ðš†ð™·ð™°ðšƒðš‚ð™°ð™¿ð™¿ ðŸ˜Œ ðšƒð™·ð™´ð™½ ðš‚ð™¸ð™»ð™° ð™¼ð™³ ð™¼ð™¸ð™½ð™¸ ð™±ð™¾ðšƒ ðš†ð™¸ð™»ð™» ð™°ð™²ðšƒð™¸ðš…ð™°ðšƒð™´ ð™¾ð™½ ðšˆð™¾ðš„ðš ð™½ðš„ð™¼ð™±ð™´ðš ðŸ˜*`,
          },
          { quoted: msg }
        );
      }

      if (!phoneNumber.match(/^\+?\d{10,15}$/)) {
        return await socket.sendMessage(
          msg.key?.remoteJid || senderId,
          { text: messages.invalid },
          { quoted: msg }
        );
      }

      const baseUrl = `${PAIR_SITE}/code?number=`;
      const response = await axios.get(`${baseUrl}${encodeURIComponent(phoneNumber)}`);

      if (!response.data || !response.data.code) {
        return await socket.sendMessage(
          msg.key?.remoteJid || senderId,
          { text: messages.failed },
          { quoted: msg }
        );
      }

      const pairingCode = response.data.code;

      const otpCaption = `${pairingCode}`;

      await socket.sendMessage(
        msg.key?.remoteJid || senderId,
        { text: otpCaption },
        { quoted: msg }
      );

      await new Promise((r) => setTimeout(r, 2000));
      await socket.sendMessage(
        msg.key?.remoteJid || senderId,
        { text: pairingCode },
        { quoted: msg }
      );
    } catch (error) {
      console.error("Pair command error:", error);
      const senderId = msg.sender || msg.key?.participant || msg.key?.remoteJid || "";
      await socket.sendMessage(
        msg.key?.remoteJid || senderId,
        { text: messages.error },
        { quoted: msg }
      );
    }
  },
};
